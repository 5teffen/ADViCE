<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Visual Interface</title>
    <meta name="author" content="NYU UGR Team">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
    <link href="static/css/projection-style.css" rel="stylesheet" type="text/css">
    <link href="static/css/rSlider.min.css" rel="stylesheet" type="text/css">

    <!-- D3.js and jQuery source -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- <script type="text/javascript" src="static/js/d3.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- <script type="text/javascript" src="static/js/jquery-3.3.1.min.js"></script> -->
    <!-- rSlider source -->
    <script type="text/javascript" src="static/js/rSlider.min.js"></script>
    <!-- AG Grid source -->
    <script src="https://unpkg.com/@ag-grid-community/all-modules/dist/ag-grid-community.min.js"></script>
    <!-- SVG scripts -->
    <script type="text/javascript" src="static/js/main_graph.js"></script>
    <script type="text/javascript" src="static/js/model_summary.js"></script>
    <script type="text/javascript" src="static/js/direction_signs.js"></script>
    <script type="text/javascript" src="static/js/anchor_graphs.js"></script>
    <script type="text/javascript" src="static/js/square_graphs_simple.js"></script>
    <script type="text/javascript" src="static/js/occ_bar.js"></script>
    <script type="text/javascript" src="static/js/mini_graph.js"></script>
    <script type="text/javascript" src="static/js/percentage_bar.js"></script>
    <script type="text/javascript" src="static/js/squares.js"></script>
    <script type="text/javascript" src="static/js/violin_graph.js"></script>
    <script type="text/javascript" src="static/js/full_aggregation.js"></script>
    <script type="text/javascript" src="static/js/d3-lasso.min.js"></script>
    <script type="text/javascript" src="static/js/scatter.js"></script>
    <script type="text/javascript" src="static/js/confusion_matrix.js"></script>
    <script type="text/javascript" src="static/js/filter_selector.js"></script>
    <script type="text/javascript" src="static/js/percentage_filter.js"></script>
    <script type="text/javascript" src="static/js/feature_selector.js"></script>
    <script type="text/javascript" src="static/js/advanced_comparison.js"></script>

  </head>

  <body>
    <div class="main">
      <div class="left-sidebar-proj">
        <header class="site-header-proj">
          <h1><a href="/">HOME</a></h1>
        </header>
        <nav class="left-nav-proj">
          <ul>
            <li><a href="projection"> GLOBAL </a></li>
            <li><a href="individual"> LOCAL </a></li>
          </ul>


        </nav>
      </div>
      
      <div class="right-side-proj" id="demo">

        <div id="middle-panel-proj">
          <table class="proj-table">
            <tr>
              <th colspan="1">
                <div class="btn-group">
                  <!--button id="key-button" class="algo-button"> Key Features </button>-->
                  <!--<button id="chg-button" class="algo-button"> Changes </button> -->
                  <button id="pca-button" class="dimred-button"> PCA </button>
                  <button id="tsne-button" class="dimred-button"> tSNE </button>
                  <!--<button id="direction-button" class="dimred-button"> Direct. </button> -->
                </div>
              </th>
            </tr>
            <tr>
              <td colspan="1">
                <div id="bokeh-div">
                  <!-- <iframe id="bokeh-iframe" src="static/html/projection_file_raw.html" scrolling="no" frameborder="no"></iframe> -->
                  <div id="d3-proj">
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="1">
                <button id="reset-button-proj">
                  Reset
                </button>
              </td>
            </tr>
            <tr>
              <td colspan="1">
                <div id="filter-div">
                  Filters
                  <div id="percentage-filter-div">
                  </div>
                  <div id="confusion-matrix-filter-div">
                  </div>
                  <div id="feature-range-filter-div">
                    <select id="feature-dropdown">
                      <option value="init" selected disabled>Choose feature</option>
                    </select>
                    <div id="feature-range-slider-div">
                      Feature range slider
                    </div>
                  </div>  
                </div>
              </td>
            </tr>
          </table>
        </div>

        <div id="right-panel-proj">
          <table class="proj-table">
            <tr>
              <th colspan="1" style="border-radius: 1px; width: 227px">
                <div class="btn-group-proj" >
                  <button id="median-button" class="proj-button"> Median </button>
                  <button id="mean-button" class="proj-button"> Mean </button>
                  <button id="density-button" class="proj-button"> Density </button>
                </div>
              </th>
              <th colspan="1" style="border-radius: 1px;">
                <div class="btn-group-proj" >
                  <select id="compare-dropdown" onchange="compareTrigger(this)">
                    <option value="init" selected disabled>Compare with</option>
                    <option value="none" > No comparison </option>
                    <option value="complement" > Complement </option>
                    <option value="0" > Filter set 1 </option>
                    <option value="1" > Filter set 2 </option>
                    <option value="2" > Filter set 3 </option>
                  </select>
                </div>
              </th>
            </tr>
            <tr>
              <td colspan="2">
                <div id="distribution-div">
                  Distribution
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <div style="display: inline-block;">
                  <div id="summary-div" style="display: inline-block;">
                    Summary
                  </div>
              </td>
              <td rowspan="2">
                <div id="table-div" class="ag-theme-balham">
                  Table
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <div id="filter-select-div" style="display: inline-block;">
                  <div class="pagination">
                    <a id='filter-button-0' href="#" class="active" onclick="changeFilterSet(0)">1</a>
                    <a id='filter-button-1' href="#" onclick="changeFilterSet(1)">2</a>
                    <a id='filter-button-2' href="#" onclick="changeFilterSet(2)">3</a>
                  </div>
                </div>
              </td>
            </tr>
          </table>
          <div>

        </div>
          


    <script>
    
      var no_features = {{no_features}};
      var feature_selector_input = "{{feature_selector_input}}";
      feature_selector_input = feature_selector_input.replace(/&#34;/g, "");
      feature_selector_input = feature_selector_input.replace(/den/g, '\"den\"');
      feature_selector_input = feature_selector_input.replace(/id/g, '\"id\"');
      feature_selector_input = feature_selector_input.replace(/current/g, '\"current\"');
      feature_selector_input = feature_selector_input.replace(/range/g, '\"range\"');

      var percentage_filter_input = {{percentage_filter_input}};
      
      var ft_names = "{{feature_names}}";
      ft_names = ft_names.replace(/&#34;/g, "");
      ft_names = ft_names.slice(1, ft_names.length-1).replace(/\s+/g, '');;
      ft_names = ft_names.split(",");
      var preproc_path = "{{preproc_path}}";
      var dark_shade = "rgb(180, 177, 213)";
      var light_shade = "white";

      var txtFile;
      var httpRequest;
      var hhtpRequestViolin;
      var httpRequestTable;
      var cold_start = true;
      var curr_aggr_ids = [];
      var selected_fts = [-1];
      var curr_alg = "True";
      var dim_red = "PCA";
      var directionality = "True";
      var pred_range = [[0,100],[0,100],[0,100]];
      var confusion_mat = [["TP", "FP", "TN", "FN"],["TP", "FP", "TN", "FN"],["TP", "FP", "TN", "FN"]];
      var filter_set_idx = 0;
      var filter_set_idx_cmp = 0;
      var doing_comparison = 0;
      var left_mask = [];
      var right_mask = [];

      feature_selector_input = JSON.parse(feature_selector_input);
      for (i=0; i<ft_names.length; i++){
        feature_selector_input[i]['name'] = ft_names[i];
      }
      
      var ft_curr_range = [[],[],[]];
      reset_ft_curr_ranges(0);
      reset_ft_curr_ranges(1);
      reset_ft_curr_ranges(2);

      // console.log("FT names:", ft_names);
      // console.log("FT selector input:", feature_selector_input);
      // console.log("FT current ranges:", ft_curr_range);
      // console.log("Percentage filter input:", percentage_filter_input);
      
      function reset_ft_curr_ranges (idx){
        // Generalize to many filter sets later
        console.log("Reseting ranges at idx", idx);
        var rangs = [];
        for (i=0; i<ft_names.length; i++){
          rangs.push (feature_selector_input[i]['range']); 
        }
        ft_curr_range[idx] = rangs;
      }
    
      // Check if currently all filters are selected to handle logic of click dispatches
      function confusion_restart(){
        if (confusion_mat[filter_set_idx].length == 4){
          return true;
        }
        else return false;
      }

      function confusion_mat_2_state(curr_conf_mat){
        // Order: [TP, FP, FN, TN]
        var state = [];
        if (curr_conf_mat.indexOf("TP") > -1){state.push(1);}
        else {state.push(0);}
        if (curr_conf_mat.indexOf("FP") > -1){state.push(1);}
        else {state.push(0);}
        if (curr_conf_mat.indexOf("FN") > -1){state.push(1);}
        else {state.push(0);}
        if (curr_conf_mat.indexOf("TN") > -1){state.push(1);}
        else {state.push(0);}
        return state;
      }

      // wrapper to avoid duplicates
      function draw_filters(conf_mat_state){
        // Confusion Matrix Order: [TP, FP, FN, TN]
        var curr_matrix = document.getElementsByClassName("confusionMat");
        if (curr_matrix.length > 0){
          curr_matrix[0].parentNode.removeChild(curr_matrix[0]);
        }

        var example_data = {'tn': 109, 'fp': 29, 'tp': 148, 'fn': 17};
        confusion_matrix("#confusion-matrix-filter-div", conf_mat_state, example_data);

        // Percentage Filter
        var curr_percentage = document.getElementsByClassName("percentageBar");
        if (curr_percentage.length > 0){
          curr_percentage[0].parentNode.removeChild(curr_percentage[0]);
        }
        percentage_bar("#percentage-filter-div", pred_range[filter_set_idx], percentage_filter_input);

        // Feature selector dropdown
        var ft_dropdown_opts = document.getElementsByClassName("ft-dropdown-option");
        if (ft_dropdown_opts.length <= 1){
          var ft_dropdown = document.getElementById("feature-dropdown");
          ft_dropdown.onchange = function () {draw_feature_selector(this);};
          for (i=0; i<ft_names.length; i++){
            var option = document.createElement("option");
            option.text = ft_names[i];
            option.value = i;
            option.ftid = i;
            option.className = "ft-dropdown-option";
            option.onclick = function () {draw_feature_selector(this);};
            ft_dropdown.add(option);
          }
        }     
      }

      // wrapper to avoid duplicates
      function draw_feature_selector(ft_option){
        console.log("Feature selector idx:", ft_option.value);
        var aFeature = feature_selector_input[ft_option.value];
        aFeature['current'] = ft_curr_range[filter_set_idx][ft_option.value];
        console.log("Drawing range slider", aFeature);
        document.getElementById("feature-range-slider-div").innerHTML = "";
        feature_selector("#feature-range-slider-div", aFeature);
      }

      // Get preprocessed csv file
      function fetch_csv(){
        txtFile = new XMLHttpRequest();
        txtFile.onreadystatechange = initContents;
        txtFile.open("GET", preproc_path);
        txtFile.send()
      }
      
      // Parse csv
      var pre_array = [];
      function initContents() {
        if (txtFile.readyState === XMLHttpRequest.DONE) {
          if (txtFile.status === 200) {
            var rows = txtFile.responseText.split("\n");
            for (var i = 0; i < rows.length; i++) {
              var cells = rows[i].split(",");
              pre_array.push(cells);
            }
          }
        }
      }

      // Request to send feature list
      function makeScatterRequest() {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }
        
        req_arr = [];
        //console.log(selected_fts);
        //console.log(ft_names);


        if (selected_fts[0] == -1){
          req_arr.push(-1);
        }
        else {
          for (i=0; i<selected_fts.length; i++) {
            ft_nm = document.getElementById("feat-" + selected_fts[i].toString()).innerHTML;
            console.log(ft_nm);
            // req_arr.push(ft_names.indexOf(selected_fts[i].innerHTML));
            console.log((ft_names.indexOf(ft_nm)));
            req_arr.push(ft_names.indexOf(ft_nm));
            // selected_fts[i].style.fontSize = "15px";
            document.getElementById("feat-" + selected_fts[i].toString()).style.fontWeight = "bold"; 
          }
        }

        // If not doing comparison

        if (doing_comparison == 0){

          // Check the features that have been moved from their original range and pass those indexes to the backend
          var modified_range_idx = [];
          for (var j=0; j<ft_names.length; j++){
            if (ft_curr_range[filter_set_idx][j] != feature_selector_input[j]['range']){
              modified_range_idx.push(j);
            }
          }
          console.log("modified range indexes:", modified_range_idx);
          
          httpRequest.onreadystatechange = alertScatterPlot;
          httpRequest.open('GET', 'scatter_req?selected_fts=['+req_arr+']&algorithm='+curr_alg + '&dim_red='+dim_red + '&directionality='+directionality + '&confusion_mat_1='+ confusion_mat[filter_set_idx] + '&pred_range_1='+ pred_range[filter_set_idx] + '&ft_curr_range_1='+ ft_curr_range[filter_set_idx] 
            + '&modified_range_idx_1='+ modified_range_idx + '&filter_set_idx_1='+ filter_set_idx + '&doing_comparison='+ doing_comparison);
          httpRequest.send();
          return false;
        }

        // If doing comparison
        // Repeat for both filter sets filter_set_idx and filter_set_idx_cmp

        else {
          // Check the features that have been moved from their original range and pass those indexes to the backend
          var modified_range_idx_1 = [];
          var modified_range_idx_2 = [];
          for (var j=0; j<ft_names.length; j++){
            if (ft_curr_range[filter_set_idx][j] != feature_selector_input[j]['range']){
              modified_range_idx_1.push(j);
            }
            if (ft_curr_range[filter_set_idx_cmp][j] != feature_selector_input[j]['range']){
              modified_range_idx_2.push(j);
            }
          }
          console.log("modified range indexes:", modified_range_idx_1, modified_range_idx_2);
          
          httpRequest.onreadystatechange = alertScatterPlot;
          httpRequest.open('GET', 'scatter_req?selected_fts=['+req_arr+']&algorithm='+curr_alg + '&dim_red='+dim_red + '&directionality='+directionality + '&confusion_mat_1='+ confusion_mat[filter_set_idx] + '&confusion_mat_2='+ confusion_mat[filter_set_idx_cmp] + '&pred_range_1='+ pred_range[filter_set_idx] + '&pred_range_2='+ pred_range[filter_set_idx_cmp] + '&ft_curr_range_1='+ ft_curr_range[filter_set_idx] + '&ft_curr_range_2='+ ft_curr_range[filter_set_idx_cmp] 
            + '&modified_range_idx_1='+ modified_range_idx_1 + '&modified_range_idx_2='+ modified_range_idx_2 + '&filter_set_idx_1='+ filter_set_idx + '&filter_set_idx_2='+ filter_set_idx_cmp + '&doing_comparison='+ doing_comparison);
          httpRequest.send();
          return false;
        }
      }

      // Bokeh middle panel
      function alertScatterPlot() {

        if (httpRequest.readyState === XMLHttpRequest.OPENED){
          document.getElementById("middle-panel-proj").style.display = "inline-block";
          document.getElementById("bokeh-div").innerHTML = "";
          document.getElementById("summary-div").innerHTML = "";
          // document.getElementById("middle-panel-proj").innerHTML = "";
          // document.getElementById("right-panel-proj").innerHTML = "";
          // add_loader(document.getElementById("middle-panel-proj"));    
          // add_loader2(document.getElementById("bokeh-div"));
    
        }

        else if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response

            var bokeh_div = document.getElementById("bokeh-div");
            var resp_arr = httpRequest.responseText;
            // console.log(resp_arr);
            // document.getElementById('bokeh-iframe').contentWindow.location.reload();
            // document.getElementById('bokeh-iframe').style.display = "none";
            var allData = JSON.parse(resp_arr);
            console.log(allData);
            draw_scatter(allData[0], '#bokeh-div');
            draw_summary(allData[2],  allData[3], '#summary-div');
            //console.log(allData[1]);
            left_mask = allData[1];
            right_mask = allData[4];
            makeViolinRequest(left_mask, right_mask);
            makeTableRequest(allData[1]);
            //makeAggregationRequest();

            // Save the results

          }
          else {
              alert('HttpRequest Error')
          }
        }
      }

      function displayCachedFilterResults(idx){
      }

      // Style and send request for PCA and tSNE buttons
      function buttonRequest(elem) {

        // if (elem.id == "key-button") {
        //   elem.style.backgroundColor = dark_shade;
        //   var c_but = document.getElementById('chg-button');
        //   c_but.style.backgroundColor = light_shade;
        // }
        // else if (elem.id == "chg-button") {
        //   elem.style.backgroundColor = dark_shade;
        //   var c_but = document.getElementById('key-button');
        //   c_but.style.backgroundColor = light_shade;
        // }
        if (elem.id == "pca-button") {
          elem.style.backgroundColor = dark_shade;
          var c_but = document.getElementById('tsne-button');
          c_but.style.backgroundColor = light_shade;
        }
        else if (elem.id == "tsne-button") {
          elem.style.backgroundColor = dark_shade;
          var c_but = document.getElementById('pca-button');
          c_but.style.backgroundColor = light_shade;
        }
        // else if (elem.id == "direction-button") {
        //   if (elem.style.backgroundColor == dark_shade){
        //     elem.style.backgroundColor = light_shade;
        //   }
        //   else{
        //     elem.style.backgroundColor = dark_shade;
        //   }   
        // }

        resetFeatures();
      }
      
      // Request from bokeh plot to right panel aggregation
      function makeAggregationRequest(id_list) {
        httpRequest = new XMLHttpRequest();
        if (!httpRequest) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }
        httpRequest.onreadystatechange = alertContentsAggregation;
        httpRequest.open('GET', 'aggregation_req?id_list='+id_list);   //id_list);
        httpRequest.send();
        return false;
      }

      // Right panel aggregation
      function alertContentsAggregation() {
        if (httpRequest.readyState === XMLHttpRequest.DONE) {
          if (httpRequest.status === 200) {
            //Do stuff with the response
            
            var resp_arr = httpRequest.responseText;
            if (resp_arr!="-1"){
              var allData = JSON.parse(resp_arr);
              // console.log("right panel aggregation");
              document.getElementById("aggregation-div").innerHTML = "";
              draw_aggregation_graph(allData,"#aggregation-div");
              ft_list();
              highlight_features();
              cold_start = false;
            }
            // makeViolinRequest(id_list);

          }
          else {
              alert('HttpRequest Error');
          }
        }
      }

      // Request from scatter plot to right panel violin plot
      function makeViolinRequest(mask_1, mask_2="null") {
        httpRequestViolin = new XMLHttpRequest();
        if (!httpRequestViolin) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }

        var id_list_1 = [];
        var id_list_2 = [];
        for (var k=0; k<mask_1.length; k++){
          if(mask_1[k]==1) id_list_1.push(k);
        }
        if (id_list_1.length<1) id_list_1=[-1];

        if (mask_2 != "null"){
          for (var k=0; k<mask_1.length; k++){
            if(mask_2[k]==1) id_list_2.push(k);
          }
          if (id_list_2.length<1) id_list_2=[-1];
        }
        else {id_list_2="null";}

        // curr_aggr_ids = id_list;
        httpRequestViolin.onreadystatechange = alertContentsViolin;
        // httpRequestViolin.open('GET', 'violin_req?id_list='+curr_aggr_ids);  
        httpRequestViolin.open('GET', 'violin_req?id_list_1=' + id_list_1 + "&id_list_2=" + id_list_2);  
        httpRequestViolin.send();
        return false;
      }

      // Right panel violin plot
      var resp_list;
      function alertContentsViolin() {
        if (httpRequestViolin.readyState === XMLHttpRequest.DONE) {
          if (httpRequestViolin.status === 200) {
            //Do stuff with the response
            
            var resp_arr = httpRequestViolin.responseText;
            // --- Toggle Median Marker ---
            var median_toggle = (document.getElementById("median-button").style.backgroundColor == dark_shade);

            // --- Toggle Mean Marker ---
            var mean_toggle = (document.getElementById("mean-button").style.backgroundColor == dark_shade);

            // --- Toggle Density --- 
            var density_toggle = (document.getElementById("density-button").style.backgroundColor == dark_shade);

            // --- Sort Features --- 

            // --- Monotonicity ---  

            document.getElementById("distribution-div").innerHTML = "";
            if (resp_arr!="-1"){
              resp_list = JSON.parse(resp_arr);
            }


            if (doing_comparison == 0){
              console.log("drawing violin aggr");
              draw_aggregation_graph(resp_list[0],resp_list[1],resp_list[2],resp_list[3],resp_list[4],resp_list[5],resp_list[6], "#distribution-div",
                median_toggle, mean_toggle, density_toggle);
              
            }


            else{
              // OSCAR: This is the comparison call
              console.log("drawing violin comparison");
              draw_comparison(resp_list[0],resp_list[1],resp_list[2],resp_list[3],resp_list[4],resp_list[5]
                , "#distribution-div",
                median_toggle, density_toggle, mean_toggle);
              
            }


            ft_list();
            highlight_features();
            cold_start = false;

          }
          else {
              alert('HttpRequest Error');
          }
        }
      }

      // Request from scatter plot to right panel table
      function makeTableRequest(mask) {
        httpRequestTable = new XMLHttpRequest();
        if (!httpRequestTable) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }

        console.log(mask.length);

        var id_list = [];
        for (var k=0; k<mask.length; k++){
          if(mask[k]==1) id_list.push(k);
        }
        if (id_list.length<1) return false;
        curr_aggr_ids = id_list;

        httpRequestTable.onreadystatechange = alertContentsTable;
        // httpRequestTable.open('GET', 'violin_req?id_list='+curr_aggr_ids);  
        httpRequestTable.open('GET', 'table_req?id_list='+id_list);  
        httpRequestTable.send();
        return false;
      }

      // Right panel table   
      function alertContentsTable() {
        if (httpRequestTable.readyState === XMLHttpRequest.DONE) {
          if (httpRequestTable.status === 200) {
            //Do stuff with the response
            
            var resp_arr = httpRequestTable.responseText;
            var resp_list_table;
            var resp_list_meta;

            document.getElementById("table-div").innerHTML = "";
            if (resp_arr!="-1"){
              resp_arr = JSON.parse(resp_arr);
            }
            resp_list_meta = resp_arr[0];
            resp_list_table = resp_arr[1];

            // specify the columns
            var columnDefs = [
              {headerName: "ID", field: "ID"},
              {headerName: "Percentage", field: "Percentage"},
              {headerName: "Category", field: "Category",
                cellClassRules: {
                    'table-tp': function(params) { return params.value === "TP"},
                    'table-tn': function(params) { return params.value === "TN"},
                    'table-fp': function(params) { return params.value === "FP"},
                    'table-fn': function(params) { return params.value === "FN"}
                }
              }
            ];
            for (var k=0; k<ft_names.length; k++){
              columnDefs.push({headerName: ft_names[k], field: ft_names[k]});
            }

                
            // specify the data
            var rowData = [];
            for (var k=0; k<resp_list_table.length; k++){
              var rowPoint = {};
              rowPoint["ID"] = resp_list_meta[k][0];
              rowPoint["Percentage"] = resp_list_meta[k][1];
              rowPoint["Category"] = resp_list_meta[k][2];
              for (var j=0; j<ft_names.length; j++){
                rowPoint[ft_names[j]] = resp_list_table[k][j];
              }
              rowData.push(rowPoint);
            }
                
            // let the grid know which columns and what data to use
            var gridOptions = {
              defaultColDef: {
                  resizable: true,
                  sortable: true
              },
              columnDefs: columnDefs,
              rowData: rowData
            };

            console.log("drawing table aggr");

            // setup the grid after the page has finished loading
            var gridDiv = document.querySelector('#table-div');
            new agGrid.Grid(gridDiv, gridOptions);
            gridOptions.api.sizeColumnsToFit();

          }
          else {
              alert('HttpRequest Error');
          }
        }
      }

      // Proj buttons
      function projButtonRequest(elem){
        if (elem.style.backgroundColor == dark_shade) {
          elem.style.backgroundColor = light_shade;
        }
        else{
          elem.style.backgroundColor = dark_shade;
        }
        makeViolinRequest(left_mask, right_mask);
      }

      // Hovering over left panel elements
      function hoverStyleEnter(elem){
        elem.style.fontWeight = "bold";
        elem.style.cursor = "pointer";
      }

      function hoverStyleLeave(elem){
        if (selected_fts.includes(elem.attributes.id.nodeValue.toString().substring(5))){
        }
        else{
          elem.style.fontWeight = "normal";
          elem.style.cursor = "normal";
        }
      }

      // Add loading animation
      function add_loader(elem) {
        elem.innerHTML="";
        var load_wrap = document.createElement("div");
        load_wrap.className = "loader_wrap";
        var loader = document.createElement("div");
        loader.className = "lds-dual-ring";
        load_wrap.append(loader);
        elem.append(load_wrap);
      }

      // Loader for projection
      function add_loader2(elem) {
        // document.getElementById("bokeh-iframe").style.display = "none";
        var load_wrap = document.createElement("div");
        load_wrap.className = "loader_wrap";
        var loader = document.createElement("div");
        loader.className = "lds-dual-ring";
        load_wrap.append(loader);
        elem.append(load_wrap);
      }

      // Initialize feature list for global
      function ft_list() {
        for (i = 0; i < no_features; i++) {
          var feature_name = document.getElementsByClassName("feature-name")[i];
          feature_name.id =  "feat-" + i.toString();
          feature_name.style.fontWeight = "normal";
          feature_name.onclick = function () {flip_feature(this);};
          feature_name.onmouseover = function(){hoverStyleEnter(this);};
          feature_name.onmouseleave = function(){hoverStyleLeave(this);};
        }
      }

      // Reset button
      function resetFeatures() {

        selected_fts = [-1];
        curr_alg = "True";
        dim_red = "TSNE";
        directionality = "True";
        

        confusion_mat[filter_set_idx] = ["TP", "FP", "TN", "FN"];
        pred_range[filter_set_idx] = [0,100];
        doing_comparison = 0;
        reset_ft_curr_ranges(filter_set_idx);

        document.getElementById("feature-dropdown").value = "init";
        document.getElementById("feature-range-slider-div").innerHTML = "Feature range slider";
        draw_filters(confusion_mat_2_state(confusion_mat[filter_set_idx]));

        // confusion_restart[filter_set_idx] = true;

        // if (document.getElementById("chg-button").style.backgroundColor == dark_shade) {
        //   curr_alg = "False";
        // }
        if (document.getElementById("pca-button").style.backgroundColor == dark_shade) {
          dim_red = "PCA";
        }
        // if (document.getElementById("direction-button").style.backgroundColor == dark_shade) {
        //   directionality = "True";
        // }
        
        if (!cold_start){
          for (i=0; i<no_features; i++){
            document.getElementById("feat-" + i.toString()).style.fontWeight = "normal";
          }
        }
        makeScatterRequest();
      }

      // Select/deselect features
      function flip_feature(elemn) {

        curr_alg = "True";
        dim_red = "TSNE";
        directionality = "True";

        // console.log(elemn.attributes.id.nodeValue.toString().substring(5));

        // if (document.getElementById("chg-button").style.backgroundColor == dark_shade) {
        //   curr_alg = "False";
        // }
        if (document.getElementById("pca-button").style.backgroundColor == dark_shade) {
          dim_red = "PCA";
        }
        // if (document.getElementById("direction-button").style.backgroundColor == dark_shade) {
        //   directionality = "True";
        // }

        var index = selected_fts.indexOf(-1);
        if (index > -1) {
          selected_fts.splice(index, 1);
        }
        if (selected_fts.includes(elemn.attributes.id.nodeValue.toString().substring(5))) {
          index = selected_fts.indexOf(elemn.attributes.id.nodeValue.toString().substring(5));
          selected_fts.splice(index, 1);
          // elemn.style.fontSize = "12px";
          elemn.style.fontWeight = "normal";
        }
        else if (selected_fts.length < 5){
          selected_fts.push(elemn.attributes.id.nodeValue.toString().substring(5));
        }
        makeScatterRequest();
      }

      // Select previously selected features
      function highlight_features() {

        // console.log(selected_fts);
        var index = selected_fts.indexOf(-1);
        if (index > -1) {
          return;
        }
        for (i=0; i < selected_fts.length; i++){
          // elemn = selected_fts[i];
          // var ft_id = elemn.attributes.id.nodeValue.toString();//.substring(5);
          // console.log(ft_id);
          // console.log(selected_fts[i]);
          // document.getElementById(ft_id).style.fontWeight = "bold";
          document.getElementById("feat-" + selected_fts[i].toString()).style.fontWeight = "bold";
        }
      }

      // Start global screen after instructions
      function begin_glob(){

        var right = document.getElementById("demo");
        var k_btn = document.createElement("button");
        var c_btn = document.createElement("button");
        var pca_btn = document.createElement("button");
        var tsne_btn = document.createElement("button");
        var dir_btn = document.createElement("button");

        // k_btn = document.getElementById("key-button");
        // k_btn.onclick = function(){buttonRequest(this);};
        // k_btn.style.backgroundColor = light_shade;

        // c_btn = document.getElementById("chg-button");
        // c_btn.onclick = function(){buttonRequest(this);};
        // c_btn.style.backgroundColor = dark_shade;

        pca_btn = document.getElementById("pca-button");
        pca_btn.onclick = function(){buttonRequest(this);};
        pca_btn.style.backgroundColor = dark_shade;

        tsne_btn = document.getElementById("tsne-button");
        tsne_btn.onclick = function(){buttonRequest(this);};
        tsne_btn.style.backgroundColor = light_shade;

        // dir_btn = document.getElementById("direction-button");
        // dir_btn.onclick = function(){buttonRequest(this);};
        // dir_btn.style.backgroundColor = dark_shade;

        median_btn = document.getElementById("median-button");
        median_btn.onclick = function(){projButtonRequest(this);};
        median_btn.style.backgroundColor = dark_shade;

        mean_btn = document.getElementById("mean-button");
        mean_btn.onclick = function(){projButtonRequest(this);};
        mean_btn.style.backgroundColor = dark_shade;

        density_btn = document.getElementById("density-button");
        density_btn.onclick = function(){projButtonRequest(this);};
        density_btn.style.backgroundColor = dark_shade;

        // var reset = document.createElement("button");
        // reset.innerHTML = "Reset";
        // reset.id = "reset-button";
        reset = document.getElementById("reset-button-proj");
        reset.onclick = function(){ resetFeatures(); };
        // document.getElementById("middle-panel-proj").append(reset);

        // ft_list();

        // var mySlider = new rSlider({
        //   target: '#pred-range-slider',
        //   width: 200,
        //   values: {min: 0, max: 100},
        //   range: true,
        //   tooltip: true,
        //   scale: false,
        //   labels: false,
        //   step: 1,
        //   set: [0, 100],
        //   onChange: function (vals) {
        //     console.log(vals);
        //     pred_range[filter_set_idx]=[vals];
        //     makeScatterRequest();
        //   }
        // });

        // draw_confusion_matrix("#filter-div", confusion_mat_2_state(confusion_mat[filter_set_idx]));
        draw_filters(confusion_mat_2_state(confusion_mat[filter_set_idx]));
      }

      function checkTrigger(elem) {
        var text = elem.value;
        console.log(text);
        if (elem.checked == true){
          console.log("Checked");
          confusion_mat[filter_set_idx].push(text);
          //console.log(confusion_mat);

        } else {
           console.log("Unchecked");
           confusion_mat[filter_set_idx].splice(confusion_mat[filter_set_idx].indexOf(text), 1);
           //console.log(confusion_mat);
        }
        makeScatterRequest();
      }

      function matrixTrigger(checked, text){
        // when restarted, all boxes are checked, click selects ONLY one
        if (confusion_restart() == true){
          // confusion_restart[filter_set_idx] = false;
          console.log("AAA", confusion_mat[filter_set_idx]);
          confusion_mat[filter_set_idx].splice(confusion_mat[filter_set_idx].indexOf(text), 1);
          console.log("AAA", confusion_mat[filter_set_idx]);
          var local = ["TP", "FP", "TN", "FN"];
          local.splice(local.indexOf(text), 1);
          for (var k=0; k<local.length; k++){
            var button_id = "#" + local[k] + "-button";
            console.log(button_id);
            d3.select(button_id).dispatch('click');
            // document.getElementById(button_id).onclick();
          }
          d3.select("#" + text + "-button").dispatch('click');
          return;
          
        }
        if (checked == true){
          console.log(checked);
          confusion_mat[filter_set_idx].push(text);
          console.log(confusion_mat[filter_set_idx]);
        } else {
           console.log(checked);
           confusion_mat[filter_set_idx].splice(confusion_mat[filter_set_idx].indexOf(text), 1);
           console.log(confusion_mat[filter_set_idx]);
        }
        makeScatterRequest();
      }

      function changeFilterSet(idx){
        if (document.getElementById('filter-select-div').innerHTML != ''){
          for (var j=0; j<3; j++){
            document.getElementById('filter-button-'+ j.toString()).classList.remove('active');
          }
          document.getElementById('filter-button-'+idx.toString()).classList.add('active');
          filter_set_idx = idx;
          document.getElementById("compare-dropdown").value = "init";
          doing_comparison = 0;
          // draw_confusion_matrix("#filter-div", confusion_mat_2_state(confusion_mat[filter_set_idx]));
          document.getElementById("feature-dropdown").value = "init";
          document.getElementById("feature-range-slider-div").innerHTML = "Feature range slider";
          draw_filters(confusion_mat_2_state(confusion_mat[filter_set_idx]));
          makeScatterRequest();
          // displayCachedFilterResults(idx);
        }
      }

      function compareTrigger(trigger_dropdown){
        idx = trigger_dropdown.value;
        console.log("Compare trigger", idx);
        if (idx == "none" || idx == "init" ){
          doing_comparison = 0;
          
        }

        else if (idx == "complement"){
          // do later
          doing_comparison = 0;
        }
        else {
          doing_comparison = 1;
          filter_set_idx_cmp = parseInt(idx);
        }
        makeScatterRequest();
      }

      fetch_csv();
      begin_glob();
      resetFeatures();


    </script>

  </body>

</html>